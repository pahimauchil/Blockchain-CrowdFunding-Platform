import{n as g,o as C}from"./index-C-NWtsoG.js";import{p as T,q as P,cl as U}from"./index-BFJltGNr.js";var R=Object.defineProperty,G=Object.defineProperties,k=Object.getOwnPropertyDescriptors,S=Object.getOwnPropertySymbols,b=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable,W=(e,t,i)=>t in e?R(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,h=(e,t)=>{for(var i in t||(t={}))b.call(t,i)&&W(e,i,t[i]);if(S)for(var i of S(t))q.call(t,i)&&W(e,i,t[i]);return e},m=(e,t)=>G(e,k(t)),r=(e,t,i)=>new Promise((n,a)=>{var o=l=>{try{u(i.next(l))}catch(d){a(d)}},s=l=>{try{u(i.throw(l))}catch(d){a(d)}},u=l=>l.done?n(l.value):Promise.resolve(l.value).then(o,s);u((i=i.apply(e,t)).next())}),L="/sdk/2022-08-12/embedded-wallet",v=e=>`paperEwsWalletUserId-${e}`,j="walletToken",I=e=>`${j}-${e}`,Q="a",y=(e,t)=>`${Q}-${e}-${t}`,H=(e=>(e.USER_MANAGED="USER_MANAGED",e.AWS_MANAGED="AWS_MANAGED",e))(H||{}),z=(e=>(e.PAPER_EMAIL_OTP="PaperEmailOTP",e.GOOGLE="Google",e.TWITTER="Twitter",e.COGNITO="Cognito",e.AUTH0="Auth0",e.CUSTOM_JWT="CustomJWT",e))(z||{}),F=(e=>(e.LOGGED_OUT="Logged Out",e.LOGGED_IN_WALLET_INITIALIZED="Logged In, Wallet Initialized",e))(F||{}),x=(e=>(e.LOGGED_OUT="Logged Out",e.LOGGED_IN_WALLET_UNINITIALIZED="Logged In, Wallet Uninitialized",e.LOGGED_IN_NEW_DEVICE="Logged In, New Device",e.LOGGED_IN_WALLET_INITIALIZED="Logged In, Wallet Initialized",e))(x||{}),O=new Map,f=class{constructor({clientId:e}){this.isSupported=typeof window<"u"&&!!window.localStorage,this.clientId=e}getItem(e){return r(this,null,function*(){var t;return this.isSupported?window.localStorage.getItem(e):(t=O.get(e))!=null?t:null})}setItem(e,t){return r(this,null,function*(){if(this.isSupported)return window.localStorage.setItem(e,t);O.set(e,t)})}removeItem(e){return r(this,null,function*(){let t=yield this.getItem(e);return this.isSupported&&t?(window.localStorage.removeItem(e),!0):!1})}saveAuthCookie(e){return r(this,null,function*(){yield this.setItem(I(this.clientId),e)})}getAuthCookie(){return r(this,null,function*(){return this.getItem(I(this.clientId))})}removeAuthCookie(){return r(this,null,function*(){return this.removeItem(I(this.clientId))})}saveDeviceShare(e,t){return r(this,null,function*(){yield this.saveWalletUserId(t),yield this.setItem(y(this.clientId,t),e)})}getDeviceShare(){return r(this,null,function*(){let e=yield this.getWalletUserId();return e?this.getItem(y(this.clientId,e)):null})}removeDeviceShare(){return r(this,null,function*(){let e=yield this.getWalletUserId();return e?this.removeItem(y(this.clientId,e)):!1})}getWalletUserId(){return r(this,null,function*(){return this.getItem(v(this.clientId))})}saveWalletUserId(e){return r(this,null,function*(){yield this.setItem(v(this.clientId),e)})}removeWalletUserId(){return r(this,null,function*(){return this.removeItem(v(this.clientId))})}};function p(e){return new Promise(t=>{setTimeout(t,e*1e3)})}var $={height:"100%",width:"100%",border:"none",backgroundColor:"transparent",colorScheme:"light",position:"fixed",top:"0px",right:"0px",zIndex:"2147483646",display:"none"},w=new Map,V=class{constructor({link:e,iframeId:t,container:i=document.body,iframeStyles:n,onIframeInitialize:a}){this.POLLING_INTERVAL_SECONDS=1.4,this.POST_LOAD_BUFFER_SECONDS=1;let o=document.getElementById(t),s=new URL(e),u="1.2.5";if(s.searchParams.set("sdkVersion",u),!o||o.src!=s.href){if(!o){o=document.createElement("iframe");let l=h(h({},$),n);Object.assign(o.style,l),o.setAttribute("id",t),o.setAttribute("fetchpriority","high"),i.appendChild(o)}o.src=s.href,o.setAttribute("data-version",u),o.onload=this.onIframeLoadHandler(o,this.POST_LOAD_BUFFER_SECONDS,a)}this.iframe=o}onIframeLoadedInitVariables(){return r(this,null,function*(){return{}})}onIframeLoadHandler(e,t,i){return()=>r(this,null,function*(){yield new Promise((n,a)=>r(this,null,function*(){var o;let s=new MessageChannel;s.port1.onmessage=l=>{let{data:d}=l;return s.port1.close(),d.success?(w.set(e.src,!0),i&&i(),n(!0)):a(new Error(d.error))},yield p(t),(o=e?.contentWindow)==null||o.postMessage({eventType:"initIframe",data:yield this.onIframeLoadedInitVariables()},`${g()}${L}`,[s.port2])}))})}call(e){return r(this,arguments,function*({procedureName:t,params:i,showIframe:n=!1,injectRecoveryCode:a={isInjectRecoveryCode:!1}}){for(;!w.get(this.iframe.src);)yield p(this.POLLING_INTERVAL_SECONDS);return n&&(this.iframe.style.display="block",yield p(.005)),new Promise((o,s)=>{var u;if(a.isInjectRecoveryCode){let d=c=>r(this,null,function*(){var E,A;if(c.origin!==g()||c.data.type!=="paper_getRecoveryCode"||typeof c.data.userWalletId!="string")return;let D=yield(E=a.getRecoveryCode)==null?void 0:E.call(a,c.data.userWalletId);(A=this.iframe.contentWindow)==null||A.postMessage({type:"paper_getRecoveryCode_response",recoveryCode:D},g()),window.removeEventListener("message",d)});window.addEventListener("message",d)}let l=new MessageChannel;l.port1.onmessage=d=>r(this,null,function*(){let{data:c}=d;l.port1.close(),n&&(yield p(.1),this.iframe.style.display="none"),c.success?o(c.data):s(new Error(c.error))}),(u=this.iframe.contentWindow)==null||u.postMessage({eventType:t,data:i},`${g()}${L}`,[l.port2])})})}destroy(){w.delete(this.iframe.src)}},B=class extends V{constructor({clientId:e,customizationOptions:t}){super({iframeId:Z,link:J({clientId:e,path:L,queryParams:t}).href,container:document.body}),this.clientId=e}onIframeLoadedInitVariables(){return r(this,null,function*(){let e=new f({clientId:this.clientId});return{authCookie:yield e.getAuthCookie(),deviceShareStored:yield e.getDeviceShare(),walletUserId:yield e.getWalletUserId(),clientId:this.clientId}})}};function J({clientId:e,path:t,queryParams:i}){var n;let a=new URL(t,g());if(i)for(let o of Object.keys(i))a.searchParams.set(o,((n=i[o])==null?void 0:n.toString())||"");return a.searchParams.set("clientId",e),a}var Z="paper-embedded-wallet-iframe",_=class{constructor({querier:e,preLogin:t,postLogin:i,clientId:n}){this.LoginQuerier=e,this.preLogin=t,this.postLogin=i,this.clientId=n}sendPaperEmailLoginOtp(e){return r(this,arguments,function*({email:t,recoveryShareManagement:i}){yield this.preLogin();let{isNewUser:n,isNewDevice:a,recoveryShareManagement:o}=yield this.LoginQuerier.call({procedureName:"sendPaperEmailLoginOtp",params:{email:t,recoveryShareManagement:i}});return{isNewUser:n,isNewDevice:a,recoveryShareManagement:o}})}},K=class extends _{constructor(){super(...arguments),this.closeWindow=({isWindowOpenedByFn:e,win:t,closeOpenedWindow:i})=>{e?t?.close():t&&i?i(t):t&&t.close()}}loginWithPaperModal(){return r(this,null,function*(){yield this.preLogin();let e=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:{recoveryShareManagement:"AWS_MANAGED"},showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(e)})}getGoogleLoginUrl(){return r(this,null,function*(){return yield this.LoginQuerier.call({procedureName:"getHeadlessGoogleLoginLink",params:void 0})})}loginWithGoogle(e){return r(this,null,function*(){yield this.preLogin();let t=e?.openedWindow,i=!1;if(t||(t=window.open("","Login","width=350, height=500"),i=!0),!t)throw new Error("Something went wrong opening pop-up");yield this.preLogin();let{loginLink:n}=yield this.getGoogleLoginUrl();t.location.href=n;let a=yield new Promise((o,s)=>{let u=window.setInterval(()=>r(this,null,function*(){t&&t.closed&&(clearInterval(u),window.removeEventListener("message",l),s(new Error("User closed login window")))}),1e3),l=d=>r(this,null,function*(){if(d.origin===g()){if(typeof d.data!="object"){s(new Error("Invalid event data"));return}switch(d.data.eventType){case"userLoginSuccess":{window.removeEventListener("message",l),clearInterval(u),this.closeWindow({isWindowOpenedByFn:i,win:t,closeOpenedWindow:e?.closeOpenedWindow}),d.data.authResult&&o(d.data.authResult);break}case"userLoginFailed":{window.removeEventListener("message",l),clearInterval(u),this.closeWindow({isWindowOpenedByFn:i,win:t,closeOpenedWindow:e?.closeOpenedWindow}),s(new Error(d.data.error));break}case"injectDeveloperClientId":{t?.postMessage({eventType:"injectDeveloperClientIdResult",developerClientId:this.clientId},g());break}}}});window.addEventListener("message",l)});return this.postLogin({storedToken:m(h({},a.storedToken),{shouldStoreCookieString:!0}),walletDetails:m(h({},a.walletDetails),{isIframeStorageEnabled:!1})})})}loginWithPaperEmailOtp(e){return r(this,arguments,function*({email:t}){yield this.preLogin();let i=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:{email:t,recoveryShareManagement:"AWS_MANAGED"},showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(i)})}verifyPaperEmailLoginOtp(e){return r(this,arguments,function*({email:t,otp:i}){let n=yield this.LoginQuerier.call({procedureName:"verifyPaperEmailLoginOtp",params:{email:t,otp:i,recoveryShareManagement:"AWS_MANAGED"},injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(n)})}},Y=class extends _{loginWithPaperModal(e){return r(this,null,function*(){yield this.preLogin();let t=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:void 0,showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0,getRecoveryCode:e?.getRecoveryCode}});return this.postLogin(t)})}loginWithGoogle(e){return r(this,null,function*(){throw new Error("loginWithGoogle is not yet supported in the RecoveryShareManagement.USER_MANAGED flow. Please use RecoveryShareManagement.AWS_MANAGED instead.")})}loginWithPaperEmailOtp(e){return r(this,arguments,function*({email:t,recoveryCode:i}){yield this.preLogin();let n=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:{email:t,recoveryCode:i},showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(n)})}verifyPaperEmailLoginOtp(e){return r(this,arguments,function*({email:t,otp:i,recoveryCode:n}){let a=yield this.LoginQuerier.call({procedureName:"verifyPaperEmailLoginOtp",params:{email:t,otp:i,recoveryCode:n},injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(a)})}},X=class{constructor({clientId:e,advancedOptions:t,querier:i,onAuthSuccess:n}){var a;this.clientId=e,this.advancedOptions={recoveryShareManagement:(a=t?.recoveryShareManagement)!=null?a:"AWS_MANAGED"},this.AuthQuerier=i,this.localStorage=new f({clientId:e}),this.onAuthSuccess=n,this.userManagedLogin=new Y({postLogin:o=>r(this,null,function*(){return this.postLogin(o)}),preLogin:()=>r(this,null,function*(){yield this.preLogin()}),querier:i,clientId:e}),this.awsManagedLogin=new K({postLogin:o=>r(this,null,function*(){return this.postLogin(o)}),preLogin:()=>r(this,null,function*(){yield this.preLogin()}),querier:i,clientId:e})}preLogin(){return r(this,null,function*(){yield this.logout()})}postLogin(e){return r(this,arguments,function*({storedToken:t,walletDetails:i}){return t.shouldStoreCookieString&&(yield this.localStorage.saveAuthCookie(t.cookieString)),yield this.onAuthSuccess({storedToken:t,walletDetails:i})})}loginWithJwtAuth(e){return r(this,arguments,function*({token:t,authProvider:i,recoveryCode:n}){yield this.preLogin();let a=yield this.AuthQuerier.call({procedureName:"loginWithJwtAuthCallback",params:{token:t,authProvider:i,recoveryCode:n}});return this.postLogin(a)})}loginWithPaperModal(e){return r(this,null,function*(){return yield this.preLogin(),this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.loginWithPaperModal():this.userManagedLogin.loginWithPaperModal(e)})}loginWithPaperEmailOtp(e){return r(this,null,function*(){return this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.loginWithPaperEmailOtp({email:e.email}):this.userManagedLogin.loginWithPaperEmailOtp(e)})}loginWithGoogle(e){return r(this,null,function*(){return this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.loginWithGoogle(e):this.userManagedLogin.loginWithGoogle()})}sendPaperEmailLoginOtp(e){return r(this,arguments,function*({email:t}){return this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.sendPaperEmailLoginOtp({email:t,recoveryShareManagement:"AWS_MANAGED"}):this.userManagedLogin.sendPaperEmailLoginOtp({email:t})})}verifyPaperEmailLoginOtp(e){return r(this,null,function*(){return this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.verifyPaperEmailLoginOtp(e):this.userManagedLogin.verifyPaperEmailLoginOtp(e)})}logout(){return r(this,null,function*(){let{success:e}=yield this.AuthQuerier.call({procedureName:"logout",params:void 0}),t=yield this.localStorage.removeAuthCookie(),i=yield this.localStorage.removeWalletUserId();return{success:e||t||i}})}},M=class{constructor({chain:e,clientId:t,querier:i}){this.chain=e,this.clientId=t,this.gaslessTransactionQuerier=i}callContract(e){return r(this,arguments,function*({contractAddress:t,methodArgs:i,methodInterface:n}){return yield this.gaslessTransactionQuerier.call({procedureName:"callContract",params:{chain:this.chain,contractAddress:t,method:{args:i,stub:n}}})})}},N=class extends P{constructor({provider:e,clientId:t,querier:i}){var n;super(),this.DEFAULT_ETHEREUM_CHAIN_ID=5,this.clientId=t,this.querier=i,this.endpoint=(n=e.connection)==null?void 0:n.url,U(this,"provider",e)}getAddress(){return r(this,null,function*(){let{address:e}=yield this.querier.call({procedureName:"getAddress",params:void 0});return e})}signMessage(e){return r(this,null,function*(){var t,i,n,a;let o=yield(t=this.provider)==null?void 0:t.getNetwork();o&&o._defaultProvider;let{signedMessage:s}=yield this.querier.call({procedureName:"signMessage",params:{message:e,chainId:(a=(n=yield(i=this.provider)==null?void 0:i.getNetwork())==null?void 0:n.chainId)!=null?a:this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return s})}signTransaction(e){return r(this,null,function*(){var t,i,n;let{signedTransaction:a}=yield this.querier.call({procedureName:"signTransaction",params:{transaction:e,chainId:(n=(i=yield(t=this.provider)==null?void 0:t.getNetwork())==null?void 0:i.chainId)!=null?n:this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return a})}_signTypedData(e,t,i){return r(this,null,function*(){var n,a,o;let{signedTypedData:s}=yield this.querier.call({procedureName:"signTypedDataV4",params:{domain:e,types:t,message:i,chainId:(o=(a=yield(n=this.provider)==null?void 0:n.getNetwork())==null?void 0:a.chainId)!=null?o:this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return s})}connect(e){return new N({clientId:this.clientId,provider:e,querier:this.querier})}},ee=class{constructor({clientId:e,chain:t,querier:i}){this.clientId=e,this.chain=t,this.walletManagerQuerier=i,this.gasless=new M({chain:t,clientId:e,querier:i}),this.localStorage=new f({clientId:e})}postWalletSetUp(e){return r(this,arguments,function*({deviceShareStored:t,walletAddress:i,isIframeStorageEnabled:n,walletUserId:a}){return n||(yield this.localStorage.saveDeviceShare(t,a)),{walletAddress:i}})}getUserWalletStatus(){return r(this,null,function*(){let e=yield this.walletManagerQuerier.call({procedureName:"getUserStatus",params:void 0});return e.status==="Logged In, Wallet Initialized"?{status:"Logged In, Wallet Initialized",user:m(h({},e.user),{wallet:this})}:e})}setChain(e){return r(this,arguments,function*({chain:t}){this.chain=t,this.gasless=new M({chain:t,clientId:this.clientId,querier:this.walletManagerQuerier})})}getEthersJsSigner(e){return r(this,null,function*(){var t;return new N({clientId:this.clientId,provider:T((t=e?.rpcEndpoint)!=null?t:C[this.chain]),querier:this.walletManagerQuerier})})}},re=class{constructor({clientId:e,chain:t,styles:i,advancedOptions:n,onAuthSuccess:a}){this.clientId=e,this.querier=new B({clientId:e,customizationOptions:i}),this.wallet=new ee({clientId:e,chain:t,querier:this.querier}),this.auth=new X({clientId:e,advancedOptions:h({recoveryShareManagement:"USER_MANAGED"},n??{}),querier:this.querier,onAuthSuccess:o=>r(this,null,function*(){return yield this.wallet.postWalletSetUp(m(h({},o.walletDetails),{walletUserId:o.storedToken.authDetails.userWalletId})),yield this.querier.call({procedureName:"initIframe",params:{deviceShareStored:o.walletDetails.deviceShareStored,clientId:this.clientId,walletUserId:o.storedToken.authDetails.userWalletId,authCookie:o.storedToken.cookieString}}),a?.(o),{user:{status:"Logged In, Wallet Initialized",authDetails:o.storedToken.authDetails,wallet:this.wallet,walletAddress:o.walletDetails.walletAddress}}})})}getUser(){return r(this,null,function*(){let e=yield this.wallet.getUserWalletStatus();switch(e.status){case"Logged In, New Device":case"Logged In, Wallet Uninitialized":return yield this.auth.logout(),this.getUser();case"Logged Out":return{status:"Logged Out"};case"Logged In, Wallet Initialized":return h({status:"Logged In, Wallet Initialized"},e.user)}})}};export{I as AUTH_TOKEN_LOCAL_STORAGE_NAME,z as AuthProvider,y as DEVICE_SHARE_LOCAL_STORAGE_NAME,re as PaperEmbeddedWalletSdk,H as RecoveryShareManagement,F as UserStatus,x as UserWalletStatus,v as WALLET_USER_ID_LOCAL_STORAGE_NAME};
