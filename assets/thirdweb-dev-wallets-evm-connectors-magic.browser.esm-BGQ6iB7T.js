import{aN as s,L as c,K as g}from"./index-BnY9_9DF.js";import{n as h}from"./normalizeChainId-1fb9aedf.browser.esm-rnfdrQqf.js";import{Y as u,b as p}from"./index-jSVtmSJf.js";import{W as m}from"./WagmiConnector-2f14002d.browser.esm-ClCkxEx9.js";class w extends m{constructor(i){super(i),s(this,"id","magic-link"),s(this,"name","Magic Link"),s(this,"ready",!0),this.magicOptions=i.options}async getAccount(){const e=await new c(await this.getProvider()).getSigner().getAddress();return e.startsWith("0x")?e:`0x${e}`}async getProvider(){if(this.provider)return this.provider;const i=this.getMagicSDK();return this.provider=i.rpcProvider,this.provider}async getSigner(){return await new c(await this.getProvider()).getSigner()}async isAuthorized(){const i=this.getMagicSDK();try{return await i.user.isLoggedIn()}catch{return!1}}onAccountsChanged(i){i.length===0?this.emit("disconnect"):i[0]&&this.emit("change",{account:g(i[0])})}onChainChanged(i){const t=h(i),e=this.isChainUnsupported(t);this.emit("change",{chain:{id:t,unsupported:e}})}onDisconnect(){this.emit("disconnect")}async disconnect(){await this.getMagicSDK().user.logout()}}class I extends w{constructor(i){super(i),this.magicSdkConfiguration=i.options.magicSdkConfiguration,this._type=i.options.type,this.oauthProviders=i.options.oauthOptions?.providers||[],this.oauthRedirectURI=i.options.oauthOptions?.redirectURI}async connect(i){if(!this.magicOptions.apiKey)throw new Error("Magic API Key is not provided.");try{i.chainId&&this.initializeMagicSDK({chainId:i.chainId});const t=await this.getProvider();this.setupListeners(),this.emit("message",{type:"connecting"});const e=await this.isAuthorized();let n;try{n=await this.getChainId()}catch{n=0}if(this._connectedChainId=n,e)return{provider:t,chain:{id:n,unsupported:!1},account:await this.getAccount()};const r=this.getMagicSDK();if(this._type==="connect")("email"in i||"phoneNumber"in i)&&console.warn("Passing email or phoneNumber is not required for Magic Connect"),await r.wallet.connectWithUI();else if("oauthProvider"in i)await r.oauth.loginWithRedirect({provider:i.oauthProvider,redirectURI:this.oauthRedirectURI||window.location.href}),await new Promise(o=>{setTimeout(o,1e4)});else if("email"in i)await r.auth.loginWithMagicLink({email:i.email,showUI:!0});else if("phoneNumber"in i)await r.auth.loginWithSMS({phoneNumber:i.phoneNumber});else throw new Error("Invalid options: Either provide and email, phoneNumber or oauthProvider when using Magic Auth");let a=await(await this.getSigner()).getAddress();return a.startsWith("0x")||(a=`0x${a}`),{account:a,chain:{id:n,unsupported:!1},provider:t}}catch(t){throw console.error(t),new Error("Something went wrong")}}async getChainId(){const i=this.magicSdkConfiguration?.network;if(typeof i=="object"){const t=i.chainId;if(t)return h(t)}throw new Error("Chain ID is not defined")}initializeMagicSDK(){let{chainId:i}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t={...this.magicSdkConfiguration,extensions:[new u]};if(i){const e=this.chains.find(n=>n.chainId===i);e&&(t.network={rpcUrl:e.rpc[0]||"",chainId:e.chainId})}return this.magicSDK=new p(this.magicOptions.apiKey,t),this.provider=this.magicSDK.rpcProvider,this.magicSDK}getMagicSDK(){return this.magicSDK?this.magicSDK:this.initializeMagicSDK()}async setupListeners(){const i=await this.getProvider();i.on("accountsChanged",this.onAccountsChanged),i.on("chainChanged",this.onChainChanged),i.on("disconnect",this.onDisconnect)}async switchChain(i){const t=this.chains.find(e=>e.chainId===i);if(!t)throw new Error("Chain not found");return this._connectedChainId!==i&&this.initializeMagicSDK({chainId:i}),t}}export{I as MagicAuthConnector,w as MagicBaseConnector};
