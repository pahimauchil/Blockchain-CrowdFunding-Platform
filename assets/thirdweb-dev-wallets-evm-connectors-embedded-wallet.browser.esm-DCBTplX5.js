import{p as O,aN as h,q as W,t as A,v as D,aQ as T,aO as v,K as N}from"./index-BFJltGNr.js";import{n as C}from"./normalizeChainId-1fb9aedf.browser.esm-rnfdrQqf.js";import{o as b}from"./index-C-NWtsoG.js";const U="/sdk/2022-08-12/embedded-wallet",p=()=>localStorage.getItem("IS_THIRDWEB_DEV")==="true"?window.localStorage.getItem("THIRDWEB_DEV_URL")??"http://localhost:3000":"https://embedded-wallet.thirdweb.com",m=n=>`thirdwebEwsWalletUserId-${n}`,k="walletToken",I=n=>`${k}-${n}`,G="a",E=(n,e)=>`${G}-${n}-${e}`;let g=(function(n){return n.COGNITO="Cognito",n.GOOGLE="Google",n.EMAIL_OTP="EmailOtp",n.CUSTOM_JWT="CustomJWT",n.CUSTOM_AUTH_ENDPOINT="CustomAuthEndpoint",n.FACEBOOK="Facebook",n.APPLE="Apple",n.PASSKEY="Passkey",n.EXTERNAL_WALLET="ExternalWallet",n.DISCORD="Discord",n})({}),u=(function(n){return n.LOGGED_OUT="Logged Out",n.LOGGED_IN_WALLET_UNINITIALIZED="Logged In, Wallet Uninitialized",n.LOGGED_IN_NEW_DEVICE="Logged In, New Device",n.LOGGED_IN_WALLET_INITIALIZED="Logged In, Wallet Initialized",n})({});const _=new Map;class y{constructor(e){let{clientId:t}=e;this.isSupported=!!window.localStorage,this.clientId=t}async getItem(e){return this.isSupported?window.localStorage.getItem(e):_.get(e)??null}async setItem(e,t){if(this.isSupported)return window.localStorage.setItem(e,t);_.set(e,t)}async removeItem(e){const t=await this.getItem(e);return this.isSupported&&t?(window.localStorage.removeItem(e),!0):!1}async saveAuthCookie(e){await this.setItem(I(this.clientId),e)}async getAuthCookie(){return this.getItem(I(this.clientId))}async removeAuthCookie(){return this.removeItem(I(this.clientId))}async saveDeviceShare(e,t){await this.saveWalletUserId(t),await this.setItem(E(this.clientId,t),e)}async getDeviceShare(){const e=await this.getWalletUserId();return e?this.getItem(E(this.clientId,e)):null}async removeDeviceShare(){const e=await this.getWalletUserId();return e?this.removeItem(E(this.clientId,e)):!1}async getWalletUserId(){return this.getItem(m(this.clientId))}async saveWalletUserId(e){await this.setItem(m(this.clientId),e)}async removeWalletUserId(){return this.removeItem(m(this.clientId))}}function L(n){return new Promise(e=>{setTimeout(e,n*1e3)})}const M={height:"100%",width:"100%",border:"none",backgroundColor:"transparent",colorScheme:"light",position:"fixed",top:"0px",right:"0px",zIndex:"2147483646",display:"none"},f=new Map;class P{constructor(e){let{link:t,iframeId:i,container:s=document.body,iframeStyles:r,onIframeInitialize:o}=e;h(this,"POLLING_INTERVAL_SECONDS",1.4),this.iframeBaseUrl=p();let a=document.getElementById(i);const l=new URL(t),d="2.5.39";if(l.searchParams.set("sdkVersion",d),!a||a.src!==l.href){if(!a){a=document.createElement("iframe");const w={...M,...r};Object.assign(a.style,w),a.setAttribute("id",i),a.setAttribute("fetchpriority","high"),s.appendChild(a)}a.src=l.href,a.setAttribute("data-version",d);const c=w=>{if(w.data.eventType==="ewsIframeLoaded"){if(window.removeEventListener("message",c),!a){console.warn("thirdweb Iframe not found");return}this.onIframeLoadHandler(a,o)()}};window.addEventListener("message",c)}this.iframe=a}async onIframeLoadedInitVariables(){return{}}onIframeLoadHandler(e,t){return async()=>{await new Promise(async(s,r)=>{const o=new MessageChannel;o.port1.onmessage=l=>{const{data:d}=l;return o.port1.close(),d.success?(f.set(e.src,!0),t&&t(),s(!0)):r(new Error(d.error))},e?.contentWindow?.postMessage({eventType:"initIframe",data:await this.onIframeLoadedInitVariables()},this.iframeBaseUrl,[o.port2])})}}async call(e){let{procedureName:t,params:i,showIframe:s=!1}=e;for(;!f.get(this.iframe.src);)await L(this.POLLING_INTERVAL_SECONDS);return s&&(this.iframe.style.display="block",await L(.005)),new Promise((o,a)=>{const l=new MessageChannel;l.port1.onmessage=async d=>{const{data:c}=d;l.port1.close(),s&&(await L(.1),this.iframe.style.display="none"),c.success?o(c.data):a(new Error(c.error))},this.iframe.contentWindow?.postMessage({eventType:t,data:i},this.iframeBaseUrl,[l.port2])})}destroy(){f.delete(this.iframe.src)}}class R extends P{constructor(e){let{clientId:t,customizationOptions:i}=e;super({iframeId:K,link:B({clientId:t,path:U,queryParams:i}).href,container:document.body}),this.clientId=t}async onIframeLoadedInitVariables(){const e=new y({clientId:this.clientId});return{authCookie:await e.getAuthCookie(),deviceShareStored:await e.getDeviceShare(),walletUserId:await e.getWalletUserId(),clientId:this.clientId}}}function B(n){let{clientId:e,path:t,queryParams:i}=n;const s=new URL(`${t}`,p());if(i)for(const r of Object.keys(i))s.searchParams.set(r,i[r]?.toString()||"");return s.searchParams.set("clientId",e),s}const K="thirdweb-embedded-wallet-iframe";class q{constructor(e){let{querier:t,preLogin:i,postLogin:s,clientId:r}=e;this.LoginQuerier=t,this.preLogin=i,this.postLogin=s,this.clientId=r}async sendEmailLoginOtp(e){let{email:t}=e;return await this.preLogin(),await this.LoginQuerier.call({procedureName:"sendThirdwebEmailLoginOtp",params:{email:t}})}async sendSmsLoginOtp(e){let{phoneNumber:t}=e;return await this.preLogin(),await this.LoginQuerier.call({procedureName:"sendThirdwebSmsLoginOtp",params:{phoneNumber:t}})}}class H extends q{constructor(){super(...arguments),h(this,"closeWindow",e=>{let{isWindowOpenedByFn:t,win:i,closeOpenedWindow:s}=e;t?i?.close():i&&s?s(i):i&&i.close()})}async getOauthLoginUrl(e){return await this.LoginQuerier.call({procedureName:"getHeadlessOauthLoginLink",params:{authProvider:e}})}async loginWithModal(){await this.preLogin();const e=await this.LoginQuerier.call({procedureName:"loginWithThirdwebModal",params:void 0,showIframe:!0});return this.postLogin(e)}async loginWithEmailOtp(e){let{email:t}=e;await this.preLogin();const i=await this.LoginQuerier.call({procedureName:"loginWithThirdwebModal",params:{email:t},showIframe:!0});return this.postLogin(i)}getOauthPopUpSizing(e){switch(e){case g.FACEBOOK:return"width=715, height=555";default:return"width=350, height=500"}}async loginWithOauth(e){let t=e?.openedWindow,i=!1;if(t||(t=window.open("","Login",this.getOauthPopUpSizing(e.oauthProvider)),i=!0),!t)throw new Error("Something went wrong opening pop-up");const[{loginLink:s}]=await Promise.all([this.getOauthLoginUrl(e.oauthProvider),this.preLogin()]);t.location.href=s;const r=await new Promise((o,a)=>{const l=window.setInterval(async()=>{t&&t.closed&&(clearInterval(l),window.removeEventListener("message",d),a(new Error("User closed login window")))},1e3),d=async c=>{if(c.origin===p()){if(typeof c.data!="object"){a(new Error("Invalid event data"));return}switch(c.data.eventType){case"userLoginSuccess":{window.removeEventListener("message",d),clearInterval(l),this.closeWindow({isWindowOpenedByFn:i,win:t,closeOpenedWindow:e?.closeOpenedWindow}),c.data.authResult&&o(c.data.authResult);break}case"userLoginFailed":{window.removeEventListener("message",d),clearInterval(l),this.closeWindow({isWindowOpenedByFn:i,win:t,closeOpenedWindow:e?.closeOpenedWindow}),a(new Error(c.data.error));break}case"injectDeveloperClientId":{t?.postMessage({eventType:"injectDeveloperClientIdResult",developerClientId:this.clientId,authOption:e.oauthProvider},p());break}}}};window.addEventListener("message",d)});return this.postLogin({storedToken:{...r.storedToken,shouldStoreCookieString:!0},walletDetails:{...r.walletDetails,isIframeStorageEnabled:!1}})}async loginWithCustomJwt(e){let{encryptionKey:t,jwt:i}=e;await this.preLogin();const s=await this.LoginQuerier.call({procedureName:"loginWithCustomJwt",params:{encryptionKey:t,jwt:i}});return this.postLogin(s)}async loginWithCustomAuthEndpoint(e){let{encryptionKey:t,payload:i}=e;await this.preLogin();const s=await this.LoginQuerier.call({procedureName:"loginWithCustomAuthEndpoint",params:{encryptionKey:t,payload:i}});return this.postLogin(s)}async verifyEmailLoginOtp(e){let{email:t,otp:i,recoveryCode:s}=e;const r=await this.LoginQuerier.call({procedureName:"verifyThirdwebEmailLoginOtp",params:{email:t,otp:i,recoveryCode:s}});return this.postLogin(r)}async verifySmsLoginOtp(e){let{phoneNumber:t,otp:i,recoveryCode:s}=e;const r=await this.LoginQuerier.call({procedureName:"verifyThirdwebSmsLoginOtp",params:{phoneNumber:t,otp:i,recoveryCode:s}});return this.postLogin(r)}}class F{constructor(e){let{clientId:t,querier:i,onAuthSuccess:s}=e;this.clientId=t,this.AuthQuerier=i,this.localStorage=new y({clientId:t}),this.onAuthSuccess=s,this.BaseLogin=new H({postLogin:async r=>this.postLogin(r),preLogin:async()=>{await this.preLogin()},querier:i,clientId:t})}async preLogin(){await this.logout()}async postLogin(e){let{storedToken:t,walletDetails:i}=e;return t.shouldStoreCookieString&&await this.localStorage.saveAuthCookie(t.cookieString),await this.onAuthSuccess({storedToken:t,walletDetails:i})}async loginWithModal(){return this.BaseLogin.loginWithModal()}async loginWithEmailOtp(e){return this.BaseLogin.loginWithEmailOtp(e)}async loginWithCustomJwt(e){return this.BaseLogin.loginWithCustomJwt(e)}async loginWithCustomAuthEndpoint(e){return this.BaseLogin.loginWithCustomAuthEndpoint(e)}async loginWithOauth(e){return this.BaseLogin.loginWithOauth(e)}async sendEmailLoginOtp(e){let{email:t}=e;return this.BaseLogin.sendEmailLoginOtp({email:t})}async sendSmsLoginOtp(e){let{phoneNumber:t}=e;return this.BaseLogin.sendSmsLoginOtp({phoneNumber:t})}async verifyEmailLoginOtp(e){return this.BaseLogin.verifyEmailLoginOtp(e)}async verifySmsLoginOtp(e){return this.BaseLogin.verifySmsLoginOtp(e)}async logout(){const{success:e}=await this.AuthQuerier.call({procedureName:"logout",params:void 0}),t=await this.localStorage.removeAuthCookie(),i=await this.localStorage.removeWalletUserId();return{success:e||t||i}}}class S extends W{constructor(e){let{provider:t,clientId:i,querier:s}=e;super(),h(this,"DEFAULT_ETHEREUM_CHAIN_ID",5),this.clientId=i,this.querier=s,this.endpoint=t.connection?.url,A.defineReadOnly(this,"provider",t)}async getAddress(){const{address:e}=await this.querier.call({procedureName:"getAddress",params:void 0});return e}async signMessage(e){const{signedMessage:t}=await this.querier.call({procedureName:"signMessage",params:{message:e,chainId:(await this.provider?.getNetwork())?.chainId??this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return t}async signTransaction(e){const{signedTransaction:t}=await this.querier.call({procedureName:"signTransaction",params:{transaction:e,chainId:(await this.provider?.getNetwork())?.chainId??this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return t}async sendTransaction(e){if(!this.provider)throw new Error("Provider not found");const i={...await D(this.provider),...e};return super.sendTransaction(i)}async _signTypedData(e,t,i){const{signedTypedData:s}=await this.querier.call({procedureName:"signTypedDataV4",params:{domain:e,types:t,message:i,chainId:(await this.provider?.getNetwork())?.chainId??this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return s}connect(e){return new S({clientId:this.clientId,provider:e,querier:this.querier})}}class V{constructor(e){let{clientId:t,chain:i,querier:s}=e;this.clientId=t,this.chain=i,this.walletManagerQuerier=s,this.localStorage=new y({clientId:t})}async postWalletSetUp(e){let{deviceShareStored:t,walletAddress:i,isIframeStorageEnabled:s,walletUserId:r}=e;return s||await this.localStorage.saveDeviceShare(t,r),{walletAddress:i}}async getUserWalletStatus(){const e=await this.walletManagerQuerier.call({procedureName:"getUserStatus",params:void 0});return e.status===u.LOGGED_IN_WALLET_INITIALIZED?{status:u.LOGGED_IN_WALLET_INITIALIZED,...e.user,wallet:this}:e.status===u.LOGGED_IN_NEW_DEVICE?{status:u.LOGGED_IN_WALLET_UNINITIALIZED,...e.user}:e.status===u.LOGGED_IN_WALLET_UNINITIALIZED?{status:u.LOGGED_IN_WALLET_UNINITIALIZED,...e.user}:{status:e.status}}async setChain(e){let{chain:t}=e;this.chain=t}async getEthersJsSigner(e){return new S({clientId:this.clientId,provider:O(e?.rpcEndpoint??b[this.chain]),querier:this.walletManagerQuerier})}}class Q{isClientIdLegacyPaper(e){return e.indexOf("-")>0&&e.length===36}constructor(e){let{clientId:t,chain:i,styles:s,onAuthSuccess:r}=e;if(this.isClientIdLegacyPaper(t))throw new Error("You are using a legacy clientId. Please use the clientId found on the thirdweb dashboard settings page");this.clientId=t,this.querier=new R({clientId:t,customizationOptions:s}),this.wallet=new V({clientId:t,chain:i,querier:this.querier}),this.auth=new F({clientId:t,querier:this.querier,onAuthSuccess:async o=>(r?.(o),await this.wallet.postWalletSetUp({...o.walletDetails,walletUserId:o.storedToken.authDetails.userWalletId}),await this.querier.call({procedureName:"initIframe",params:{deviceShareStored:o.walletDetails.deviceShareStored,clientId:this.clientId,walletUserId:o.storedToken.authDetails.userWalletId,authCookie:o.storedToken.cookieString}}),{user:{status:u.LOGGED_IN_WALLET_INITIALIZED,authDetails:o.storedToken.authDetails,wallet:this.wallet,walletAddress:o.walletDetails.walletAddress}})})}async getUser(){return this.wallet.getUserWalletStatus()}}class $ extends T{constructor(e){super(),h(this,"id",v.paper),h(this,"name","Embedded Wallet"),h(this,"ready",!0),h(this,"user",null),h(this,"onAccountsChanged",async t=>{t.length===0?await this.onDisconnect():this.emit("change",{account:N(t[0])})}),h(this,"onChainChanged",t=>{const i=C(t),s=this.options.chains.findIndex(r=>r.chainId===i)===-1;this.emit("change",{chain:{id:i,unsupported:s}})}),h(this,"onDisconnect",async()=>{this.emit("disconnect")}),this.options=e}getEmbeddedWalletSDK(){return this._embeddedWalletSdk||(this._embeddedWalletSdk=new Q({clientId:this.options.clientId,chain:"Ethereum",onAuthSuccess:this.options.onAuthSuccess})),this._embeddedWalletSdk}async connect(e){if(e){if(!e.authResult)throw new Error("Missing authData - call authenticate() first with your authentication strategy");if(!e.authResult.user)throw new Error("Missing authData.user - call authenticate() first with your authentication strategy");this.user=e.authResult.user}else{const t=await this.authenticate({strategy:"iframe"});if(!t.user)throw new Error("Error connecting User");this.user=t.user}return e?.chainId&&this.switchChain(e.chainId),this.getAddress()}async disconnect(){await this._embeddedWalletSdk?.auth.logout(),this._signer=void 0,this._embeddedWalletSdk=void 0,this.user=null}async getAddress(){if(!this.user)throw new Error("Embedded Wallet is not connected");return await this.getSigner().then(e=>e.getAddress())}async isConnected(){try{return!!await this.getAddress()}catch{return!1}}async getProvider(){const e=await this.getSigner();if(!e.provider)throw new Error("Provider not found");return e.provider}async getSigner(){if(this._signer)return this._signer;const t=await(await this.getUser()).wallet.getEthersJsSigner({rpcEndpoint:this.options.chain.rpc[0]||""});if(!t)throw new Error("Signer not found");return this._signer=t,t}async isAuthorized(){return!1}async switchChain(e){const t=this.options.chains.find(i=>i.chainId===e);if(!t)throw new Error("Chain not configured");try{await this.user?.wallet.setChain({chain:"Ethereum"}),this._signer=await this.user?.wallet.getEthersJsSigner({rpcEndpoint:t.rpc[0]||""}),this.emit("change",{chain:{id:e,unsupported:!1}})}catch(i){console.warn("Failed to switch chain",i)}}async setupListeners(){return Promise.resolve()}updateChains(e){this.options.chains=e}async getUser(){if(!this.user||!this.user.wallet||!this.user.wallet.getEthersJsSigner){const t=await this.getEmbeddedWalletSDK().getUser();switch(t.status){case u.LOGGED_IN_WALLET_INITIALIZED:{this.user=t;break}default:throw new Error("Embedded Wallet is not authenticated, please authenticate first")}}return this.user}async getEmail(){return(await this.getUser()).authDetails.email}async getPhoneNumber(){return(await this.getUser()).authDetails.phoneNumber}async getRecoveryInformation(){return(await this.getUser()).authDetails}async sendVerificationEmail(e){let{email:t}=e;return this.getEmbeddedWalletSDK().auth.sendEmailLoginOtp({email:t})}async sendVerificationSms(e){let{phoneNumber:t}=e;return this.getEmbeddedWalletSDK().auth.sendSmsLoginOtp({phoneNumber:t})}async authenticate(e){const t=this.getEmbeddedWalletSDK(),i=e.strategy;switch(i){case"email_verification":return await t.auth.verifyEmailLoginOtp({email:e.email,otp:e.verificationCode,recoveryCode:e.recoveryCode});case"phone_number_verification":return await t.auth.verifySmsLoginOtp({phoneNumber:e.phoneNumber,otp:e.verificationCode,recoveryCode:e.recoveryCode});case"apple":case"facebook":case"google":{const s=z[i];return t.auth.loginWithOauth({oauthProvider:s,closeOpenedWindow:e.closeOpenedWindow,openedWindow:e.openedWindow})}case"jwt":return t.auth.loginWithCustomJwt({jwt:e.jwt,encryptionKey:e.encryptionKey});case"auth_endpoint":return t.auth.loginWithCustomAuthEndpoint({payload:e.payload,encryptionKey:e.encryptionKey});case"iframe_email_verification":return t.auth.loginWithEmailOtp({email:e.email});case"iframe":return t.auth.loginWithModal();default:x(i)}}}function x(n){throw new Error("Invalid param: "+n)}const z={google:g.GOOGLE,facebook:g.FACEBOOK,apple:g.APPLE};export{$ as EmbeddedWalletConnector};
